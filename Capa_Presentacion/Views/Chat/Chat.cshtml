
@{
    ViewBag.Title = "Chat";
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Mi aplicación ASP.NET</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.2/assets/css/docs.css" rel="stylesheet">
</head>
<body class="p-0 m-0 border-0 bd-example">
    <style>

        #header {
            padding: 20px;
            background-color: #d7e5e4;
            border-bottom: #5f9482 solid 2px;
            color: #1e4638;
            font-size: 24px;
        }

        .submitButton {
            background-color: #d7e5e4;
            border: #5f9482 solid 1px;
            padding: 4px;
            cursor: pointer;
        }

            .submitButton:hover {
                background-color: #e1e1e1;
            }

        .login {
            width: 250px;
            margin-left: auto;
            margin-right: auto;
            padding: 10px;
            border: solid 2px #5f9482;
            color: #1e4638;
        }

            .login .textBox {
                width: 240px;
            }


            .login #divButton {
                padding: 4px;
                text-align: right;
            }

        .chatRoom {
            width: 650px;
            margin-left: auto;
            margin-right: auto;
            border: solid 1px gray;
        }

            .chatRoom .title {
                font-size: 16px;
                font-weight: bold;
                padding: 8px;
                background-color: #d7e5e4;
                border-bottom: solid 1px #5f9482;
            }

            .chatRoom .content {
                height: 300px;
                clear: both;
            }

                .chatRoom .content .chatWindow {
                    float: left;
                    width: 409px;
                    height: 300px;
                    border-right: solid 1px #5f9482;
                    overflow-y: scroll;
                }

                    .chatRoom .content .chatWindow .message {
                        padding: 4px;
                    }

                        .chatRoom .content .chatWindow .message .userName {
                            font-weight: bold;
                        }

                .chatRoom .content .users {
                    float: right;
                    width: 240px;
                    height: 300px;
                }

                    .chatRoom .content .users .user {
                        display: block;
                        cursor: pointer;
                        padding: 4px;
                        background-color: #f9f9f9;
                        border-bottom: solid 1px #5f9482;
                    }

                    .chatRoom .content .users .loginUser {
                        display: block;
                        padding: 4px;
                        color: gray;
                        border-bottom: solid 1px #5f9482;
                    }

                    .chatRoom .content .users .user:hover {
                        background-color: #e1e1e1;
                    }

            .chatRoom .messageBar {
                border-top: solid 1px gray;
                padding: 4px;
            }

                .chatRoom .messageBar .textbox {
                    width: 550px;
                }

        .disconnect {
            position: absolute;
            margin: 10px;
            background-color: #ffcbcb;
            padding: 4px;
            border: solid 1px red;
        }


        .draggable {
            position: absolute;
            border: #5f9482 solid 1px !important;
            width: 250px;
        }

            .draggable .header {
                cursor: move;
                background-color: #d7e5e4;
                border-bottom: #5f9482 solid 1px;
                color: #1e4638;
            }

            .draggable .selText {
                color: black;
                padding: 4px;
            }

            .draggable .messageArea {
                width: 250px;
                overflow-y: scroll;
                height: 200px;
                border-bottom: #5f9482 solid 1px;
            }

                .draggable .messageArea .message {
                    padding: 4px;
                }

            .draggable .buttonBar {
                width: 250px;
                padding: 4px;
            }

                .draggable .buttonBar .msgText {
                    width: 172px;
                }

                .draggable .buttonBar .button {
                    margin-left: 4px;
                    width: 55px;
                }
    </style>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #121212;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="font-size: calc(10px + 2vmin);">Veterinaria Manatí</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                @if (User.Identity.IsAuthenticated)
                {

                    if (Session["Rol"].ToString() == "1" && Session["Rol"].ToString() != null)
                    {
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Home/">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Account/Usuarios">Usuarios</a>
                            </li>
                        </ul>
                    }
                    else if (Session["Rol"].ToString() == "2" && Session["Rol"].ToString() != null)
                    {
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Home/">Home</a>
                            </li>
                        </ul>
                    }

                    <ul class="nav navbar-nav navbar-right">
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Account/Perfil">@User.Identity.Name</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Account/Logout">Cerrar Sesión</a>
                        </li>
                    </ul>
                }
                else
                {
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Home/">Home</a>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Account/Login">Iniciar Sesión</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: calc(5px + 2vmin);" href="/Account/Create">Registrarse</a>
                        </li>
                    </ul>
                }
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="col-md-12">
            <h2>Create</h2>


            @using (Html.BeginForm())
            {
                @Html.AntiForgeryToken()

        <div class="form-horizontal">
            <h4>Chat</h4>
            <h2>@ViewBag.id</h2>
            <hr />
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <section style="background-color: #CDC4F9;" id="section">
            <div class="container py-5">

                <div class="row">
                    <div class="col-md-12">

                        <div class="card" id="chat3" style="border-radius: 15px;">
                            <div class="card-body">

                                <div class="row" id="row">
                                    <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">

                                        <div class="p-3">

                                            <div class="overflow-auto" id="overflow" style="position: relative; height: 400px">
                                                <ul class="list-unstyled mb-0" id="row2">
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
            <div id="divContainer">
                <div id="divLogin" class="login">
                    <div>
                        Your Name:<br />
                        <input id="txtNickName" type="text" class="textBox" />
                    </div>
                    <div id="divButton">
                        <input id="btnStartChat" type="button" class="submitButton" value="Start Chat" />
                    </div>
                </div>

                <div id="divChat" class="chatRoom">
                    <div class="title">
                        Welcome to Chat Room [<span id='spanUser'></span>]

                    </div>
                    <div class="content">
                        <div id="divChatWindow" class="chatWindow">
                        </div>
                        <div id="divusers" class="users">
                        </div>
                    </div>

                </div>

                <input id="hdId" type="text" />
                <input id="hdUserName" type="text" />
            </div>
        </div>
            }
        </div>
    </div>

    <script src="https://kit.fontawesome.com/2f21f67d01.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.js"></script>
    <script src="~/Scripts/ui/jquery.ui.core.js"></script>
    <script src="~/Scripts/ui/jquery.ui.widget.js"></script>
    <script src="~/Scripts/ui/jquery.ui.mouse.js"></script>
    <script src="~/Scripts/ui/jquery.ui.draggable.js"></script>
    <script src="~/Scripts/ui/jquery.ui.resizable.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="http://www.codeproject.com/signalr/hubs"></script>
    <script src="~/signalr/hubs"></script>

</body>
</html>

<script type="text/javascript">

    $(function () {

        setScreen(false);

        // Declare a proxy to reference the hub.
        var chatHub = $.connection.chatHub;

        registerClientMethods(chatHub);

        // Start Hub
        $.connection.hub.start().done(function () {

            registerEvents(chatHub);

        });

    });

    function setScreen(isLogin) {

        if (!isLogin) {

            $("#divChat").hide();
            $("#divLogin").show();
        }
        else {

            $("#divChat").show();
            $("#divLogin").hide();
        }

    }

    function registerEvents(chatHub) {

        $("#btnStartChat").click(function () {

            var name = $("#txtNickName").val();
            if (name.length > 0) {
                chatHub.server.connect(name);
            }
            else {
                alert("Please enter name");
            }

        });


        $('#btnSendMsg').click(function () {

            var msg = $("#txtMessage").val();
            if (msg.length > 0) {

                var userName = $('#hdUserName').val();
                chatHub.server.sendMessageToAll(userName, msg);
                $("#txtMessage").val('');
            }
        });


        $("#txtMessage").keypress(function (e) {
            if (e.which == 13) {
                $('#btnSendMsg').click();
            }
        });


    }

    function registerClientMethods(chatHub) {

        // Calls when user successfully logged in
        chatHub.client.onConnected = function (id, userName, allUsers, messages) {

            setScreen(true);

            $('#hdId').val(id);
            $('#hdUserName').val(userName);
            $('#spanUser').html(userName);

            // Add All Users
            for (i = 0; i < allUsers.length; i++) {

                AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName);
            }

            // Add Existing Messages
            for (i = 0; i < messages.length; i++) {

                AddMessage(messages[i].UserName, messages[i].Message);
            }


        }

        // On New User Connected
        chatHub.client.onNewUserConnected = function (id, name) {

            AddUser(chatHub, id, name);
        }


        // On User Disconnected
        chatHub.client.onUserDisconnected = function (id, userName) {

            $('#' + id).remove();

            var ctrId = 'private_' + id;
            $('#' + ctrId).remove();


            var disc = $('<div class="disconnect">"' + userName + '" logged off.</div>');
            

            //$(disc).hide();
            //$('#' + id).prepend(disc);
            //$(disc).fadeIn(200).delay(2000).fadeOut(200);

        }

        chatHub.client.messageReceived = function (userName, message) {

            AddMessage(userName, message);
        }

        var nombre = [];
        chatHub.client.sendPrivateMessage = function (windowId, fromUserName, message) {

            var ctrId = 'private_' + windowId;


            if ($('#' + ctrId).length == 0) {

                createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName);

            }
            var chkAsientos = document.getElementsByClassName("content")

            for (let i = 0; i < chkAsientos.length; i++) {
                if (chkAsientos[i] == fromUserName) {
                    alert("Si");
                }
            }

            $('#contenido').append("<div class='d-flex flex-row justify-content-start content' id='" + fromUserName + "'>" +
                "           <img src='https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava6-bg.webp' alt='avatar 1' style='width: 45px; height: 100%;'/>" +
                "           <div id='divMessage'>" +
                "<p class='small p-2 ms-3 mb-1 rounded-3' style='background-color: #f5f6f7; '>" + fromUserName + " : " + message + "</p>"+
                "           </div>" +
                "       </div>" 
                );

            // set scrollbar
            //var height = $('#' + ctrId).find('#divMessage')[0].scrollHeight;
            //$('#' + ctrId).find('#divMessage').scrollTop(height);

        }

    }

    function AddUser(chatHub, id, name) {

        var userId = $('#hdId').val();

        var code = "";

        if (userId == id) {

/*            code = $('<div class="loginUser">' + name + "</div>");*/
            code = $("<li class='p-2 border-bottom' id='" + id + "'>" +
                "<a class='d-flex justify-content-between'>" +
                "<div class='d-flex flex-row'>" +
                "<div>" +
                "<img src='https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp' alt='avatar' class='d-flex align-self-center me-3' width='60'>" +
                "<span class='badge bg-success badge-dot'></span>" +
                "</div>" +
                "<div class='pt-1'>" +
                "<p class='fw-bold mb-0'>" + name + "</p>" +
                "<p class='small text-muted'>Hello, Are you there?</p>" +
                "</div>" +
                "</div>" +
                "<div class='pt-1'>" +
                "<p class='small text-muted mb-1'>Just now</p>" +
                "<span class='badge bg-danger rounded-pill float-end'>3</span>" +
                "</div>" +
                "</a>" +
                "</li>");

        }
        else {

/*            code = $('<a id="' + id + '" class="user" >' + name + '<a>');*/
            code = $("<li class='p-2 border-bottom' id='" + id + "'>" +
                "<a id='" + id + "' class='d-flex justify-content-between'>" +
                "<div class='d-flex flex-row'>" +
                "<div>" +
                "<img src='https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp' alt='avatar' class='d-flex align-self-center me-3' width='60'>" +
                "<span class='badge bg-success badge-dot'></span>" +
                "</div>" +
                "<div class='pt-1'>" +
                "<p class='fw-bold mb-0'>" + name + "</p>" +
                "<p class='small text-muted'>Hello, Are you there?</p>" +
                "</div>" +
                "</div>" +
                "<div class='pt-1'>" +
                "<p class='small text-muted mb-1'>Just now</p>" +
                "<span class='badge bg-danger rounded-pill float-end'>3</span>" +
                "</div>" +
                "</a>" +
                "</li>");

            $(code).dblclick(function () {

                var id = $(this).attr('id');

                if (userId != id)
                    OpenPrivateChatWindow(chatHub, id, name);

            });
        }

        $("#row2").append(code);
/*        $("#divusers").append(code);*/

    }

    function AddMessage(userName, message) {
        $('#divChatWindow').append('<div class="message"><span class="userName">' + userName + '</span>: ' + message + '</div>');

        var height = $('#divChatWindow')[0].scrollHeight;
        $('#divChatWindow').scrollTop(height);
    }

    function OpenPrivateChatWindow(chatHub, id, userName) {

        var ctrId = 'private_' + id;

        if ($('#' + ctrId).length > 0) return;

        createPrivateChatWindow(chatHub, id, ctrId, userName);

    }

    function createPrivateChatWindow(chatHub, userId, ctrId, userName) {

        if (document.getElementById("contenedor")) {

        } else {
            var div =
                "<div class='col-md-6 col-lg-7 col-xl-8' id='contenido2'>" +
                "   <div class='pt-3 pe-3 overflow-auto' id='contenido' style='position: relative; height: 400px'>" +
                
                "   </div>" +
                "      <div class='text-muted d-flex justify-content-start align-items-center pe-3 pt-3 mt-2' id='contenedor'>" +
                "           <img src='https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava6-bg.webp' alt='avatar 3' style='width: 40px; height: 100%;'/>" +
                "           <input type='text' class='form-control form-control-lg' name='comentario' id='txtPrivateMessage' placeholder='Type message'/>" +
                "           <a class='ms-1 text-muted' href='#!'><i class='fas fa-paperclip'></i></a>" +
                "           <a class='ms-3 text-muted' href='#!'><i class='fas fa-smile'></i></a>" +
                "           <a class='ms-3' id='btnSendMessage'><i class='fas fa-paper-plane'></i></a>" +
                "       </div>" +
                "</div>";
        }

        
        //var div = '<div id="' + ctrId + '" class="ui-widget-content draggable" rel="0">' +
        //    '<div class="header">' +
        //    '<div  style="float:right;">' +
        //    '<img id="imgDelete"  style="cursor:pointer;" src="/Images/delete.png"/>' +
        //    '</div>' +

        //    '<span class="selText" rel="0">' + userName + '</span>' +
        //    '</div>' +
        //    '<div id="divMessage" class="messageArea">' +

        //    '</div>' +
        //    '<div class="buttonBar">' +
        //    '<input id="txtPrivateMessage" class="msgText" type="text"   />' +
        //    '<input id="btnSendMessage" class="submitButton button" type="button" value="Send"   />' +
        //    '</div>' +
        //    '</div>';

        var $div = $(div);

        // DELETE BUTTON IMAGE
        $div.find('#imgDelete').click(function () {
            $('#' + ctrId).remove();
        });

        // Send Button event
        $div.find("#btnSendMessage").click(function () {

            $textBox = $div.find("#txtPrivateMessage");
            var msg = $textBox.val();
            if (msg.length > 0) {

                chatHub.server.sendPrivateMessage(userId, msg);
                $textBox.val('');
            }
        });

        // Text Box event
        $div.find("#txtPrivateMessage").keypress(function (e) {
            if (e.which == 13) {
                $div.find("#btnSendMessage").click();
            }
        });

        AddDivToContainer($div);

    }

    function AddDivToContainer($div) {
        $('#row').append($div);

       

        ////$div.resizable({
        ////    stop: function () {

        ////    }
        ////});

    }

</script>